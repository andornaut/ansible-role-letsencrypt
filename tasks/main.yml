---
- name: Install python-openssl system package
  apt:
    name: python-openssl
    state: latest
    update_cache: yes
  become: true

- name: Create directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ private_key_path|dirname }}"
    - "{{ crt_directory }}"
    - "{{ csr_directory }}"
  become: true

- name: Create account key and private key
  openssl_privatekey:
    path: "{{ item }}"
  register: create_keys
  with_items:
    - "{{ account_key_path }}"
    - "{{ private_key_path }}"
  become: true

- name: Delete CSRs if keys have changed
  file:
    path: "{{ csr_directory }}"
    state: absent
  when: create_keys|changed
  become: true

- name: Create CSR directory
  file:
    path: "{{ csr_directory }}"
    state: directory
  become: true

- name: Create CSRs
  openssl_csr:
    path: "{{ csr_directory }}/{{ item.domain }}.csr"
    privatekey_path: "{{ private_key_path }}"
    countryName: CA
    commonName: "{{ item.domain }}"
  register: create_csrs
  when: item.use_snakeoil_certificate is not defined or not item.use_snakeoil_certificate
  with_items: "{{ websites }}"
  become: true

- name: Initiate Letsencrypt challenge
  letsencrypt:
    account_email: "{{ account_email }}"
    account_key: "{{ account_key_path }}"
    acme_directory: "{{ acme_directory }}"
    csr: "{{ csr_directory }}/{{ item.domain }}.csr"
    dest: "{{ crt_directory }}/{{ item.domain }}.crt"
    remaining_days: "{{ remaining_days }}"
  register: letsencrypt_challenge
  when: item.use_snakeoil_certificate is not defined or not item.use_snakeoil_certificate
  with_items: "{{ websites }}"
  become: true

- name: Create challenge resource directories
  file:
    path: "{{ web_root_directory }}/{{ item.item.domain }}/{{ item['challenge_data'][ item.item.domain ]['http-01']['resource']|dirname }}"
    state: directory
  when:
    - item.changed
    - not item | skipped
  with_items: "{{ letsencrypt_challenge.results }}"
  become: true

- name: Copy challenge resources
  copy:
    dest: "{{ web_root_directory }}/{{ item.item.domain }}/{{ item['challenge_data'][ item.item.domain ]['http-01']['resource'] }}"
    content: "{{ item['challenge_data'][ item.item.domain ]['http-01']['resource_value'] }}"
  when:
    - item.changed
    - not item | skipped
  with_items: "{{ letsencrypt_challenge.results }}"
  become: true

- name: Complete Letsencrypt challenge
  letsencrypt:
    account_email: "{{ account_email }}"
    account_key: "{{ account_key_path }}"
    acme_directory: "{{ acme_directory }}"
    csr: "{{ csr_directory }}/{{ item.item.domain }}.csr"
    dest: "{{ crt_directory }}/{{ item.item.domain }}.crt"
    data: "{{ item }}"
    remaining_days: "{{ remaining_days }}"
  register: issue_certificates
  when:
    - item.changed
    - not item | skipped
  with_items: "{{ letsencrypt_challenge.results }}"
  become: true
